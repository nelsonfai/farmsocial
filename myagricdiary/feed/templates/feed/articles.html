{% extends 'main/base.html'%}
{% block content %}
{% load static %}
<div class="grid-container">

<main> 
            <div style="margin-bottom:20px">
                {% if user.is_authenticated %}
                    <a href="{% url 'add_article'%}">
                        <div class="create-post">
                           <div class="left">
                            {% if user.profile_pic%}
                            <span class="roundedprofile" style="background:url('{{user.profile_pic.url}}') ;background-position: center; background-size: contain;">  </span> 
                            {% else %}
                            <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR9RzmCAKhjBMu6GN8LHxNLTw8Vt347xfIXWA&usqp=CAU" alt="" width="40px">
                            {% endif %}
                            <span> Share a thought</span>
                           </div>
                           <div class="right">                        
                                <span> <i class="fa-regular fa-image" style="font-size: 1.5rem;"></i> </span>
                                <span> <i class="fa-solid fa-pen-to-square" style="font-size: 1.5rem; "></i> </span>
                           </div>
                        </div>
                    </a>
                {% endif %}  
            </div>
            {% if articles %}
            {% for article in articles %}
                    <div class="article-item" id="article{{article.id}}"> 
                        <div class="author-info">
                            <div class="right"> 
                              {% if not article.author.profile_pic %}
                              <span> 
                                <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcR9RzmCAKhjBMu6GN8LHxNLTw8Vt347xfIXWA&usqp=CAU" alt="" width="30px"> 
                              </span>
                              {% else %}
                              <span class="roundedprofile" style="background:url('{{article.author.profile_pic.url}}') ;background-position: center; background-size: contain;">  </span> 
                              {% endif %}
                              <div> 
                                    <a href="{%  url 'profile' article.author.id %}"><span> {{ article.author.first_name|title}} {{ article.author.last_name|title }} </span></a> 
                                    <p> {{ article.whenpublished }}</p>
                                </div>
                            </div>

                            <div> 
                                {% if article.author == request.user %}
                                <div class="dropdown">
                                    <span class="dropbtn" onclick="myFunction(data='myDropdown{{article.id}}')">...</span>
                                    <div id="myDropdown{{article.id}}" class="dropdown-content">
                                      <span><button onclick="deleteConfirm(event,id='article{{article.id}}', article_id='{{article.id}}' )">Delete</button></span>

                                    </div>
                                  </div>
                                  
                                {% endif %}
                                <span>
                                    {% if article.author != request.user %}
                                      {% if article.author in mynetwork.following.all %}
                                        <a href="{% url 'createchat' article.author.id %}"> <button>Message</button> </a>
                                      {% else %}
                                         <button onclick="network(event,url='follow', profile_id='{{article.author.id}}' ,id='{{article.id}}followbtn{{article.author.id}}')" id="{{article.id}}unfollowbtn{{article.author.id}}">+Follow</button>
                                      {% endif %}
                                  {% endif %}
                                </span>
                            </div>
                        </div>
                        <div class="article-body toggle-text">
                                    <p id ='text'>{{article.body|safe}} </p>
                                    <button id="toggle-button"> show less </button>
                        </div>

                        {% if article.article_image %} 
                        <div class="article_image">     
                            <img src="{{ article.article_image.url }}" alt="article image" width="100%">
                        </div>

                        {% endif %}
                        <div class="engagment"> 
                            <span>                                    
                                <span class="like-button" data-id="{{ article.id }}" >
                                    {% if user not in article.likes.all %}
                                    <img src="{% static 'images/like.png' %}" width="25px">
                                    {% else %}
                                    <img src="{% static 'images/love.png'%}" alt="liked" width ="25px">
                                    {% endif %}  
                                </span>

                                <span class="likes">{{article.likes.all.count}} </span>
                            </span> 

                            <a href=" {% url 'details' article_slug=article.slug %}"><span> Share </span></a>
                            <a href=" {% url 'details' article_slug=article.slug %}"><span> Comment ({{ article.comments.all.count }})</span></a>
                         </div>
                    </div>
                    
            {% endfor %}
            
        <div style="margin-block:20px 40px"> 
                <p style="text-align:center;"> Page  {{ articles.number }} of  {{ articles.paginator.num_pages }} </p> 
            <div class="pagination11"> 
                <p> {% if articles.has_previous %}
                    <span style="text-align:left;padding-left:1rem;"> 
                            <a href="?page={{ articles.previous_page_number }}"> &laquo; Previous</a>
                    </span >  
                {% endif %}
                    {% if articles.has_next %}
                    <span style="text-align: right; display: block; padding-right:1rem;" >
                        <a href="?page={{ articles.next_page_number }}" >Next <i> &raquo;</i> </a>
                    </span>
                    {% endif%}
                </p>
                </div>  
        </div>   
        {% else %}
            <p style="text-align: center; background-color: #fff; padding: 1rem;"> No Item </p>
        {%endif%} 
</main>

<div class="sidebar sidebar_right">
    <div class="filter">
      <form action="">
        <input type="search" name="" id="" placeholder="Search article">
        <button> <i class="fa-solid fa-magnifying-glass" style="font-size: 1.4rem; color:grey" ></i></button>
      </form>
      <p>Filter by Tag</p>
      <br>
      {% for tag in tags %}
       
          <div><a href="{% url 'filter' tag.name %}">{{tag.name}} </a></div>
      
      {%endfor%}
      
    </div> 
    <div class="networksugestion">
        <p>My Followers </p>

        {% for item in friendsuggestions%}
        <div class="flex flex_outerfollow" style="justify-content: space-between;"> 
            <div class="flex" > 
                <a href="{% url 'profile' item.user.id %}"> <span class="roundedprofile" style="background:url('{{ item.user.profile_pic.url}}') ;background-position: center; background-size: contain;" > </span> </a>
                    <div>
                        <a href="{% url 'profile' item.user.id %}"> <div class="contact-name"> {{ item.user.get_full_name|title }} </div>	</a>
                    </div>
            </div>
            <div> 
                {% if item.user != request.user %}
                <span>
                    {% if item.user in mynetwork.following.all %}
                        <button onclick="network(event,url='unfollow', profile_id='{{item.user.id}}',id='itembtn')" >Unfollow</button>
                    {% else %}
                        <button onclick="network(event,url='follow', profile_id='{{item.user.id}}' ,id='itembtn')" >Follow</button>
                    {% endif %}
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
       
    </div>
    <div> 
    </div>
</div>

</div>
</main>
<style>
  .sidebar_right{
    padding: 0;
    background-color: transparent;
  }

  .filter form{
    width: 100%;
    display: flex;
    align-items: center;
    gap:7px;
    margin-bottom: 15px;

  }
  .filter input{
    width: 100%;
    padding: .6rem;
    background-color: white;
    border: 1px solid grey;
    border-radius: 5px;
  }
  .filter div{
    padding: .5rem;
    margin-block: .3rem;
    display: inline-block;
    border-radius: 5px;
    background-color: #f1f1f1;
  }
  .filter div:hover{
    background-color: #f5f5f5;
  }

  button{
    color: #d4c44b;
    color: black;
    padding: 0.3rem;
    background-color: rgba(212,196,75,.7);

  }
 
</style>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
  function network(event,url,profile_id,id){
          console.log('logded in')
          event.preventDefault();
          var btn = document.getElementById(id)
          var link = '/friends/' + url + '/' + profile_id
          console.log(link)
          $.ajax({
              url: link,
              type: 'GET',
              success: function(result) {
              // Handle the success response
              console.log(result)
              if (result.data === 'follow'){
      
                btn.parentElement.innerHTML = `<button onclick="network(event,url='follow', profile_id='${profile_id}', id='${id}')" > +Follow </button>`;
                btn.remove();
               }
              else{
                
                btn.parentElement.innerHTML = `<button onclick="network(event,url='unfollow', profile_id='${profile_id}', id='${id}')"> unfollow </button>`;
                btn.remove();
} 
              }
          });
          

}

</script>
<script>
    function myFunction(id) {      
  let elt =document.getElementById(id);
  console.log(elt)
  elt.classList.toggle("show")
    }
</script>
<script>
        $(document).ready(function(){
  $(".like-button").click(function(e){
    e.preventDefault();
    var post_id = $(this).data('id');
    var likeButton = $('[data-id="'+post_id+'"]');
    console.log(likeButton)
  
    console.log(likeButton)
    var likes_span = $(this).siblings('.likes');
    $.ajax({
      url: '/' + post_id + '/like',
      dataType: 'json',
      success: function(data) {
        likes_span.text(data.likes);
        if (data.userLike === true) {
            likeButton.html(`<img src="{% static 'images/love.png' %}" width="25px">`)
        } else {
            likeButton.html(`<img src="{% static 'images/like.png' %}" width="25px">`)
        }
           
      }
    });
  });
});


</script>
<script>
const elements = document.getElementsByClassName("toggle-text");
for (let i = 0; i < elements.length; i++) {

  const element = elements[i];
  const fullText = element.innerText;
  const shortText = fullText.substring(0, 100) + "... show more";
 
  element.innerText = shortText;
  let isTruncated = false;
  element.addEventListener("click", function() {
   
    if (isTruncated) {
    
      element.innerText = shortText;
    } else {
      element.innerText = fullText;
    }

    isTruncated = !isTruncated;
  });
}

</script>
<script>

function deleteConfirm(event,id,article_id){
        if (confirm('Do you want to delete this tracker.Action is irreversible')){
            event.preventDefault();
            var post = document.getElementById(id)
            console.log(id)
            console.log(article_id)
            $.ajax({
                url: '/delete_article/' + article_id ,
                type: 'GET',
                success: function(result) {
                // Handle the success response

                post.remove();
                }
            });
            
        }
        else{
            event.preventDefault();

}
}

</script>




{% endblock %}