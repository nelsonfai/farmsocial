{% extends 'main/base.html'%}
{% block content %}
{% load static %}
<link rel="stylesheet" href="{% static 'styles/feed.css' %}">
<div class="grid-container">

<main> 
            <div style="margin-bottom:20px">
                {% if user.is_authenticated %}
                    <a href="{% url 'add_article'%}">
                        <div class="create-post">
                           <div class="left">
                            <span class="roundedprofile" style="background:url('{{user.profilepic}}') ;background-position: center; background-size: contain;">  </span> 

                            <span> Share a thought</span>
                           </div>
                           <div class="right">                        
                                <span> <i class="fa-regular fa-image" style="font-size: 1.5rem;"></i> </span>
                                <span> <i class="fa-solid fa-pen-to-square" style="font-size: 1.5rem; "></i> </span>
                           </div>
                        </div>
                    </a>
                {% endif %}  
            </div>
            {% if query %}
            <div class="article-item" style="text-align: center;font-size: larger; "> Your search results for: {{query}} </div>
            {%endif%}
            {% if articles %}
            {% for article in articles %}
                    <div class="article-item" id="article{{article.id}}"> 
                      <div class="article-top"> 
                        <div class="author-info">
                          
                            <div class="right"> 
                              {% if article.author %}
                              <span class="roundedprofile" style="background:url('{{article.author.profilepic}}') ;background-position: center; background-size: contain;"> </span> 
                              <div> 
                                    <a href="{%  url 'profile' article.author.id %}"><span> {{ article.author.first_name|title}} {{ article.author.last_name|title }} </span></a> 
                                    <p> {{ article.whenpublished }}</p>
                                </div>
                                {%else%}
                                <span class="roundedprofile" style="background:url('{{article.company.logopic}}') ;background-position: center; background-size: contain;">  </span> 
                                <div> 
                                      <a href="{%  url 'companyprofile' article.company.identifier article.company.name %} "><span> {{ article.company.name|title}}  </span></a> 
                                      <p> {{ article.whenpublished }}</p>
                                  </div>
                                {%endif%}
                            </div>

                      


                            <div> 
                                {% if article.author == request.user or  article.company.user == request.user %}
                                <div class="dropdown">
                                    <span class="dropbtn" onclick="myFunction(data='myDropdown{{article.id}}')">...</span>
                                    <div id="myDropdown{{article.id}}" class="dropdown-content" style="min-width: 0;">
                                      <span><button onclick="deleteConfirm(event,id='article{{article.id}}', article_id='{{article.id}}' )">Delete</button></span>

                                    </div>
                                  </div>
                                {%else%}
                               
                                <span>
                                  {% if article.author %}
                                      {% if article.author in mynetwork.following.all %}
                                        <a href="{% url 'createchat' article.author.id %}"> <button class="button_three">Message</button> </a>
                                      {% else %}
                                         <button class="button_three" onclick="network(event,url='follow', profile_id='{{article.author.id}}' ,id='{{article.id}}followbtn{{article.author.id}}')" id="{{article.id}}unfollowbtn{{article.author.id}}">+Follow</button>
                                      {% endif %}
                                  {%endif%}
                                  {%if article.company %}
                                      {% if request.user in article.company.pagefollowers.all %}
                                      <span class="button_three" id='companyfollowbtn'  onclick="networkcompany(event, profile_id='{{article.company.identifier}}',id ='companyfollowbtn' )" style="cursor: pointer;" >Following</span>
                                      {% else %}
                                      <span class="button_three" id='companyunfollowbtn' onclick="networkcompany(event, profile_id='{{article.company.identifier}}', id='companyunfollowbtn' )" style="cursor: pointer;" >Follow</span>
                                      {% endif %}

                                  {%endif%}
                                </span>
                                {% endif %}
                            </div>
                        </div>
                       {%if article.title %} <p> {{article.title|safe}} </p> <br>{%endif%}

                        <div class="article-body toggle-text">
                                    <p id ='text'>{{article.body|safe}} </p>
                        </div>
                      </div>
                        {% if article.article_image %} 

                        <div class="article_image">     
                            <img src="{{ article.article_image.url }}" alt="article image" width="100%">
                        </div>
                        {% endif %}
                        <div class="engagment"> 
                            <span>                                    
                                <span class="like-button" data-id="{{ article.id }}" >
                                    {% if user not in article.likes.all %}
                                    <img src="{% static 'images/like.png' %}" width="25px">
                                    {% else %}
                                    <img src="{% static 'images/love.png'%}" alt="liked" width ="25px">
                                    {% endif %}  
                                </span>

                                <span class="likes">{{article.likes.all.count}} </span>
                            </span> 

                            <a href=" {% url 'details' article_slug=article.slug %}"><span> Share </span></a>
                            <a href=" {% url 'details' article_slug=article.slug %}"><span> Comment ({{ article.comments.all.count }})</span></a>
                         </div>
                    </div>
                    
            {% endfor %}
            
        <div style="margin-block:20px 40px"> 
                <p style="text-align:center;"> Page  {{ articles.number }} of  {{ articles.paginator.num_pages }} </p> 
            <div class="pagination11"> 
                <p> {% if articles.has_previous %}
                    <span style="text-align:left;padding-left:1rem;"> 
                            <a href="?page={{ articles.previous_page_number }}"> &laquo; Previous</a>
                    </span > 
                  {%else%}
                {% endif %}
                    {% if articles.has_next %}
                    <span style="text-align: right; display: block; padding-right:1rem;" >
                        <a href="?page={{ articles.next_page_number }}" >Next <i> &raquo;</i> </a>
                    </span>
                    {% endif%}
                </p>
                </div>  
        </div>   
        {% else %}
            <p style="text-align: center; background-color: #fff; padding: 1rem;"> No Articles at the moment </p>
        {%endif%} 
</main>

<div class="sidebar sidebar_right">
    <div class="filter">
      <form action="{% url 'search-article' %}" method="post">
        {% csrf_token%}
        <input type="search" name="search-query" id="search-query" placeholder="Search article">
        <button> <i class="fa-solid fa-magnifying-glass" style="font-size: 1.4rem; color:grey" ></i></button>
      </form>
      <p>Filter by Tag</p>
      <br>
      <p><a href="../../../">All articles </a></p>
      <br>
      {% for tag in tags %}
       
          <div><a href="{% url 'filter' tag.name %}">{{tag.name}} </a></div>
      
      {%endfor%}
      
    </div> 
    {% if friendsuggestions %}
    <div class="networksugestion">
        <p> People you may Know </p>
          <br>
        {% for item in friendsuggestions%}
        <div class="flex flex_outerfollow" style="justify-content: space-between;margin-bottom: 1rem;"> 
            <div class="flex" > 
                <a href="{% url 'profile' item.id %}"> <span class="roundedprofile" style="background:url('{{ item.profilepic}}') ;background-position: center; background-size: contain;" > </span> </a>
                    <div>
                        <a href="{% url 'profile' item.id %}"> <div class="contact-name"> {{ item.get_full_name|title }} </div>	</a>
                    </div>
            </div>
            <div> 
                {% if item != request.user %}
                <span>
                    {% if item in mynetwork.following.all %}
                        <button class="button_three" onclick="network(event,url='unfollow', profile_id='{{item.id}}',id='itembtn')" >Unfollow</button>
                    {% else %}
                        <button class="button_three" onclick="network(event,url='follow', profile_id='{{item.id}}' ,id='itembtn')" >Follow</button>
                    {% endif %}
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
       
    </div>
    {% endif %}
    <div> 
    </div>
</div>

</div>

<style>
  #text{
    cursor: pointer;
  }
  main{
    padding: 0 !important;
  }
  .sidebar_right{
    padding: 0;
    background-color: transparent;
  }

  .filter form{
    width: 100%;
    display: flex;
    align-items: center;
    gap:7px;
    margin-bottom: 15px;

  }
  .filter input{
    width: 100%;
    padding: .6rem;
    background-color: white;
    border: 1px solid grey;
    border-radius: 5px;
  }
  .filter div{
    padding: .5rem;
    margin-block: .3rem;
    display: inline-block;
    border-radius: 5px;
    background-color: #f1f1f1;
  }
  .filter div:hover{
    background-color: #f5f5f5;
  }

  button{
    color: black;
    background-color:whitesmoke;
    padding: 0.3rem 0.9rem;
    border-radius: 4rem;
    cursor: pointer;
  }
 
</style>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>

<script>
  function network(event,url,profile_id,id){
          console.log('logded in')
          event.preventDefault();
          var btn = document.getElementById(id)
          var link = '/friends/' + url + '/' + profile_id
          console.log(link)
          $.ajax({
              url: link,
              type: 'GET',
              success: function(result) {
              // Handle the success response
              console.log(result)
              if (result.data === 'follow'){
      
                btn.parentElement.innerHTML = `<button class="button_three" onclick="network(event,url='follow', profile_id='${profile_id}', id='${id}')" > +Follow </button>`;
                btn.remove();
               }
              else{
                
                btn.parentElement.innerHTML = `<button class="button_three" onclick="network(event,url='unfollow', profile_id='${profile_id}', id='${id}')"> unfollow </button>`;
                btn.remove();
} 
              }
          });
          

}

</script>
<script>
    function myFunction(id) {      
  let elt =document.getElementById(id);
  console.log(elt)
  elt.classList.toggle("show")
    }
</script>
<script>
        $(document).ready(function(){
  $(".like-button").click(function(e){
    e.preventDefault();
    var post_id = $(this).data('id');
    var likeButton = $('[data-id="'+post_id+'"]');
    console.log(likeButton)
  
    console.log(likeButton)
    var likes_span = $(this).siblings('.likes');
    $.ajax({
      url: '/' + post_id + '/like',
      dataType: 'json',
      success: function(data) {
        likes_span.text(data.likes);
        if (data.userLike === true) {
            likeButton.html(`<img src="{% static 'images/love.png' %}" width="25px">`)
        } else {
            likeButton.html(`<img src="{% static 'images/like.png' %}" width="25px">`)
        }
           
      }
    });
  });
});


</script>
<script>
  const elements = document.getElementsByClassName("toggle-text");
  for (let i = 0; i < elements.length; i++) {
  const element = elements[i];
  const text = element.innerText.trim();
  if (text.length > 100) {
 
  const fullText = element.innerHTML  + `<span id="showmore-less" style="margin-block: 5px; color:#d4c44b ;cursor: pointer;" >...less </span>
`;
  const shortText = element.innerHTML.substring(0, 100) + ` <span id="showmore-less" style="margin-block: 5px; color:#d4c44b ;cursor: pointer;" >... more </span>
`;
  element.innerHTML = shortText;
    let isTruncated = false;
    element.addEventListener("click", function() {
     
      if (isTruncated) {
      
      element.innerHTML = shortText;

      } else {
      element.innerHTML = fullText;

      }
  
      isTruncated = !isTruncated;
    });
  }
} 
  </script>
<script>

function deleteConfirm(event,id,article_id){
        if (confirm('Do you want to delete this tracker.Action is irreversible')){
            event.preventDefault();
            var post = document.getElementById(id)
            console.log(id)
            console.log(article_id)
            $.ajax({
                url: '/delete_article/' + article_id ,
                type: 'GET',
                success: function(result) {
                // Handle the success response

                post.remove();
                }
            });
            
        }
        else{
            event.preventDefault();

}
}

</script>

<script>
  function networkcompany(url,profile_id,id){
          console.log('logded in')
          console.log(id)
          var btn = document.getElementById(id)
          var link = '/company/followpage/' + profile_id
          console.log(id)

          console.log(btn)
          $.ajax({
              url: link,
              type: 'GET',
              success: function(result) {
              // Handle the success response
              console.log(result)
              if (result.success === 'follow'){
                btn.parentElement.innerHTML = `<span class="button_three"  id='${id}' onclick="networkcompany(event, profile_id='${profile_id}', id='${id}' )" style="cursor: pointer;" >Follow</span>`;
                btn.remove();
               }
              else{
                btn.parentElement.innerHTML = `<span  class="button_three" id='${id}'  onclick="networkcompany(event, profile_id='${profile_id}',id='${id}' )" style="cursor: pointer;" >Following</span>`;
                btn.remove();
} 
              }
          });     

}

</script>



{% endblock %}